<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSLè¯ä¹¦ç”Ÿæˆå·¥å…· - <%= title %></title>
  <link rel="stylesheet" href="/stylesheets/style.css" />
  <script src="/js/jquery-3.6.0.min.js"></script>
  <script src="/js/FileSaver.min.js"></script>
  <script src="/js/jszip.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="certDiv">
      <div class="title-new">ğŸ”’ SSLè¯ä¹¦ç”Ÿæˆå·¥å…·</div>
      <div class="inputEmailDiv">
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" name="bedStatus" value="1" checked id="dns-proxy" />
            <label for="dns-proxy">DNSä»£ç†æ¨¡å¼</label>
          </div>
          <div class="radio-item">
            <input type="radio" name="bedStatus" value="2" id="dns-verify" />
            <label for="dns-verify">DNSéªŒè¯</label>
          </div>
        </div>
        
        <div class="input-group">
          <label for="domain-input">è¾“å…¥åŸŸå:</label>
          <input class="inputDev" type="text" name="domain" id="domain-input" placeholder="ä¾‹å¦‚: *.example.com æˆ– example.com" />
        </div>
        
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
          <div class="step active" id="step1">
            <div class="step-number">1</div>
            <span>é…ç½®åŸŸå</span>
          </div>
          <div class="step" id="step2">
            <div class="step-number">2</div>
            <span>DNSéªŒè¯</span>
          </div>
          <div class="step" id="step3">
            <div class="step-number">3</div>
            <span>è·å–è¯ä¹¦</span>
          </div>
        </div>
        
        <!-- è¯ä¹¦çŠ¶æ€æ£€æŸ¥åŒºåŸŸ -->
        <div class="cert-status-section" style="display: none;">
          <div class="cert-status-card">
            <h3>ğŸ“‹ è¯ä¹¦çŠ¶æ€</h3>
            <div id="certStatusInfo"></div>
            <div class="cert-actions" style="margin-top: 15px;">
              <button id="checkCertStatus" class="normalBtn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                ğŸ” æ£€æŸ¥è¯ä¹¦çŠ¶æ€
              </button>
              <button id="forceRenewCert" class="normalBtn" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); display: none;">
                ğŸ”„ å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
              </button>
            </div>
          </div>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
          <button id="getTxtRecordID">ğŸš€ å¼€å§‹ç”Ÿæˆè¯ä¹¦</button>
        </div>

        <div class="help-text">
          <p><strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
          <p>â€¢ è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ‚¨è¦ç”³è¯·è¯ä¹¦çš„åŸŸå</p>
          <p>â€¢ DNSéªŒè¯æ¨¡å¼ï¼šéœ€è¦æ‰‹åŠ¨æ·»åŠ TXTè§£æè®°å½•åˆ°æ‚¨çš„åŸŸåç®¡ç†åå°</p>
          <p>â€¢ DNSä»£ç†æ¨¡å¼ï¼šè‡ªåŠ¨å®ŒæˆéªŒè¯ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ</p>
          <p>â€¢ æ³›åŸŸåè¯ä¹¦ï¼šè¯·è¾“å…¥ *.example.com æ ¼å¼</p>
        </div>
      </div>
      <!-- æœåŠ¡å™¨è¿”å›çš„æ•°æ® -->
      <div class="showInfo">
        <!-- è¯·æ±‚Textè®°å½• -->
        <div class="serveBackInfo">
          <div style="margin-bottom: 20px; font-weight: 600; color: #667eea;">
            ğŸ“ DNSéªŒè¯ä¿¡æ¯ (è¯·åœ¨åŸŸåç®¡ç†åå°æ·»åŠ ä»¥ä¸‹è§£æè®°å½•)
          </div>
          <div class="info-item">
            <span class="info-label">ä¸»æœºè®°å½•ï¼š</span>
            <div class="cnameText" id="hostRcode"></div>
          </div>
          <div class="info-item" id="TxtRcodeType">
            <span class="info-label">è®°å½•ç±»å‹ï¼š</span>
            <span>TXT</span>
          </div>
          <div class="info-item">
            <span class="info-label">è®°å½•å€¼ï¼š</span>
            <div class="cnameText" id="TxtRcodeVlaue"></div>
          </div>
        </div>
        <div class="certInfoFatherDiv">
          <div class="certInfo"></div>
          <div class="buttonsDiv">
            <button id="getCertID" class="normalBtn">
              âš¡ ç¬¬äºŒæ­¥ï¼šè·å–è¯ä¹¦
            </button>
            <div id="certBtns">
              <button class="normalBtn" id="copyCertData">
                ğŸ“‹ å¤åˆ¶è¯ä¹¦å†…å®¹
              </button>
              <button class="normalBtn" id="copyCertKeyData">
                ğŸ”‘ å¤åˆ¶ç§é’¥å†…å®¹
              </button>
              <button class="normalBtn" id="downlaodCert">
                ğŸ’¾ ä¸‹è½½è¯ä¹¦æ–‡ä»¶
              </button>
              <button class="normalBtn" id="resetForm" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">
                ğŸ”„ é‡æ–°å¼€å§‹
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="loadingDiv">
      <div class="laodingContentxt">
        <div class="load_6"></div>
        <div>ğŸ”„ æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
      </div>
    </div>

    <div class="toastDiv">è¯·è¾“å…¥åŸŸå</div>
  </div>
  
  <!-- é¡µè„šä¿¡æ¯ -->
  <footer class="footer">
    <div class="footer-content">
      <p>ğŸ” åŸºäº ACME.sh çš„å…è´¹ SSL è¯ä¹¦ç”Ÿæˆå·¥å…·</p>
      <p>æ”¯æŒ Let's Encryptã€ZeroSSL ç­‰å¤šä¸ªè¯ä¹¦é¢å‘æœºæ„</p>
      <div class="footer-links">
        <a href="https://github.com/acmesh-official/acme.sh" target="_blank">ğŸ“š ACME.sh æ–‡æ¡£</a>
        <span>|</span>
        <a href="https://letsencrypt.org/" target="_blank">ğŸŒ Let's Encrypt</a>
      </div>
    </div>
  </footer>
</div>

  <!-- 
      Using CA: https://acme.zerossl.com/v2/DV90
      Creating domain key
      The domain key is here: /root/.acme.sh/*.wanzishu.com_ecc/*.wanzishu.com.key
      Single domain='*.wanzishu.com'
      Getting webroot for domain='*.wanzishu.com'
      Add the following TXT record:
      Domain: '_acme-challenge.wanzishu.com'
      TXT value: 'PDIRBTpCf0cGk2dLnPSG1h7655GjmBcpXA8AVFdoNHY'
      Please make sure to prepend '_acme-challenge.' to your domain
      so that the resulting subdomain is: _acme-challenge.wanzishu.com
      Please add the TXT records to the domains, and re-run with --renew.
      Please add '--debug' or '--log' to see more information.
      See: https://github.com/acmesh-official/acme.sh/wiki/How-to-debug-acme.sh 
  -->

  <!-- è¯·æ±‚CNAME -->
  <!-- acme.sh --renew -d *.hnzzwa.com --yes-I-know-dns-manual-mode-enough-go-ahead-please -k 2048 -->

  <!-- acme.sh --renew -d *.wanzishu.online  --yes-I-know-dns-manual-mode-enough-go-ahead-please -->
  <script>
    function showToast(params, time) {
      $(".toastDiv").show();
      $(".toastDiv").html(params);
      setTimeout(function () {
        $(".toastDiv").hide();
      }, time || 3000);
    }

    let selectRadio = 1;
    
    $(document).ready(function () {
      // æ·»åŠ é¡µé¢åŠ è½½åŠ¨ç”»
      $(".certDiv").css("opacity", "0").animate({opacity: 1}, 800);
      
      // æ­¥éª¤æ§åˆ¶å‡½æ•°
      function updateStep(stepNumber) {
        $('.step').removeClass('active completed');
        for (let i = 1; i < stepNumber; i++) {
          $(`#step${i}`).addClass('completed');
        }
        $(`#step${stepNumber}`).addClass('active');
      }
      
      // æ£€æŸ¥è¯ä¹¦çŠ¶æ€
      function checkCertificateStatus(domain) {
        if (!domain) {
          showToast("è¯·å…ˆè¾“å…¥åŸŸå");
          return;
        }
        
        $.ajax({
          url: "/checkCertStatus",
          type: "GET",
          data: { domain: domain },
          success: function(response) {
            if (response.code === 200) {
              displayCertificateStatus(response.data);
              $(".cert-status-section").show();
            } else if (response.code === 404) {
              displayCertificateStatus({
                exists: false,
                statusType: "none",
                statusMessage: "æœªæ‰¾åˆ°è¯ä¹¦æ–‡ä»¶"
              });
              $(".cert-status-section").show();
            } else {
              showToast("æ£€æŸ¥è¯ä¹¦çŠ¶æ€å¤±è´¥: " + response.msg);
            }
          },
          error: function() {
            showToast("æ£€æŸ¥è¯ä¹¦çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯");
          }
        });
      }
      
      // æ˜¾ç¤ºè¯ä¹¦çŠ¶æ€
      function displayCertificateStatus(data) {
        let statusHtml = '';
        let statusClass = '';
        
        switch(data.statusType) {
          case 'valid':
            statusClass = 'cert-status-valid';
            statusHtml = `
              <div class="cert-status-info ${statusClass}">
                <div>âœ… ${data.statusMessage}</div>
                <div style="margin-top: 8px; font-size: 14px;">
                  åˆ°æœŸæ—¶é—´: ${new Date(data.expiryDate).toLocaleString('zh-CN')}
                </div>
              </div>
            `;
            $("#forceRenewCert").show();
            break;
          case 'expiring':
            statusClass = 'cert-status-expiring';
            statusHtml = `
              <div class="cert-status-info ${statusClass}">
                <div>âš ï¸ ${data.statusMessage}</div>
                <div style="margin-top: 8px; font-size: 14px;">
                  åˆ°æœŸæ—¶é—´: ${new Date(data.expiryDate).toLocaleString('zh-CN')}
                </div>
                <div style="margin-top: 8px; font-size: 14px; font-weight: bold;">
                  å»ºè®®ç«‹å³é‡æ–°ç”Ÿæˆè¯ä¹¦
                </div>
              </div>
            `;
            $("#forceRenewCert").show();
            break;
          case 'expired':
            statusClass = 'cert-status-expired';
            statusHtml = `
              <div class="cert-status-info ${statusClass}">
                <div>âŒ ${data.statusMessage}</div>
                <div style="margin-top: 8px; font-size: 14px;">
                  åˆ°æœŸæ—¶é—´: ${new Date(data.expiryDate).toLocaleString('zh-CN')}
                </div>
                <div style="margin-top: 8px; font-size: 14px; font-weight: bold;">
                  å¿…é¡»é‡æ–°ç”Ÿæˆè¯ä¹¦
                </div>
              </div>
            `;
            $("#forceRenewCert").show();
            break;
          case 'error':
            statusClass = 'cert-status-error';
            statusHtml = `
              <div class="cert-status-info ${statusClass}">
                <div>âŒ ${data.statusMessage}</div>
              </div>
            `;
            $("#forceRenewCert").show();
            break;
          case 'none':
          default:
            statusClass = 'cert-status-none';
            statusHtml = `
              <div class="cert-status-info ${statusClass}">
                <div>ğŸ“ ${data.statusMessage || 'æœªæ‰¾åˆ°è¯ä¹¦'}</div>
                <div style="margin-top: 8px; font-size: 14px;">
                  è¯·ç”Ÿæˆæ–°çš„è¯ä¹¦
                </div>
              </div>
            `;
            $("#forceRenewCert").hide();
            break;
        }
        
        $("#certStatusInfo").html(statusHtml);
      }

      //input radio ç‚¹å‡»äº‹ä»¶
      $('input[type=radio]').click(function () {
        $('input:radio[name=bedStatus]').prop('checked', false);
        $(this).prop('checked', true);
        
        // æ·»åŠ é€‰ä¸­æ•ˆæœ
        $('.radio-item').removeClass('selected');
        $(this).closest('.radio-item').addClass('selected');
        
        if (this.value == 1) {
          selectRadio = 1;
          console.log("DNSä»£ç†æ¨¡å¼");
        }
        else if (this.value == 2) {
          selectRadio = 2;
          console.log("DNSéªŒè¯");
        }
      });
      //å¤åˆ¶ä¸»æœºè®°å½•
      $("#hostRcode").click(function (event) {
        navigator.clipboard.writeText($("#hostRcode").text()).then(
          function () {
            showToast("å¤åˆ¶æˆåŠŸ");
          },
          function (err) {
            console.error("å¤åˆ¶å¤±è´¥", err);
          }
        );
      });

      //å¤åˆ¶ä¸»æœºè®°å½•
      $("#TxtRcodeVlaue").click(function (event) {
        navigator.clipboard.writeText($("#TxtRcodeVlaue").text()).then(
          function () {
            showToast("å¤åˆ¶æˆåŠŸ");
          },
          function (err) {
            console.error("å¤åˆ¶å¤±è´¥", err);
          }
        );
      });

      //è¯·æ±‚Textè®°å½•
      $("#getTxtRecordID").click(function (event) {
        // var email = $('input[name="email"]').val();
        var domain = $('input[name="domain"]').val();
        // if (email === "") {
        //   alert("è¯·è¾“å…¥é‚®ç®±åœ°å€");
        //   return;
        // }
        if (domain === "") {
          showToast("è¯·è¾“å…¥åŸŸå");
          return;
        }

        if (selectRadio == 1) { //DNSä»£ç†æ¨¡å¼
          updateStep(2); // è¿›å…¥ç¬¬äºŒæ­¥
          $(".inputEmailDiv").hide(); // Hide the input field
          $("#TxtRcodeType").html("è®°å½•ç±»å‹ï¼šCNAME");
          $(".showInfo").show(); // Show the CNAME info div
          const domains = domain.split(".")
          if (domains.length > 2 && domains[0] != "*") {
            $("#hostRcode").html(`_acme-challenge.${domains[0]}`);
          } else {
            $("#hostRcode").html(`_acme-challenge`);
          }
         
          $("#TxtRcodeVlaue").html(`_acme-challenge.bbxiuc.cn`);
          $(".buttonsDiv").show();
        } else { //DNSéªŒè¯
          // åŠ è½½åŠ¨ç”»
          $(".loadingDiv").show();

          $.ajax({
            url: "/getTxtRecord",
            type: "GET",
            data: {
              // email: email,
              domain: domain,
              forceRenew: window.forceRenew || false,
            },
            success: function (data) {
              updateStep(2); // è¿›å…¥ç¬¬äºŒæ­¥
              $(".inputEmailDiv").hide(); // Hide the input field
              // Handle the response from the server
              console.log(data);
              // åŠ è½½åŠ¨ç”»
              $(".loadingDiv").hide();
              $(".showInfo").show(); // Show the CNAME info div

              // æ­£åˆ™åŒ¹é… Domain å’Œ TXT value
              const match = data.data.stdout.match(/Domain: '(.*?)'/);
              const hostRecodeText = match ? match[1] : null;

              const match2 = data.data.stdout.match(/TXT value: '(.*?)'/);
              const recodeText = match2 ? match2[1] : null;

              console.log("Domain:", hostRecodeText);
              console.log("TXT Value:", recodeText);
              if (hostRecodeText && recodeText) {
                $("#hostRcode").html(
                  hostRecodeText.replace(
                    `.${domain.split(".")[1]}.${domain.split(".")[2]}`,
                    ""
                  )
                );
                $("#TxtRcodeVlaue").html(recodeText);
                $(".buttonsDiv").show();
              } else {
                $(".serveBackInfo").html(
                  data.data.stdout + "\n" + data.data.stderr
                ); // Update the CNAME info div with the response
              }
            },
            error: function (xhr, status, error) {
              // Handle any errors
              console.error("Error:", error);
            },
          });
        }


      });

      let outputData = null;
      // è·å–è¯ä¹¦
      $("#getCertID").click(function (event) {
        // var email = $('input[name="email"]').val();
        var domain = $('input[name="domain"]').val();
        $(".loadingDiv").show();
        $.ajax({
          url: "/validate",
          type: "GET",
          data: {
            // email: email,
            domain: domain,
            dnstype: selectRadio,
            forceRenew: window.forceRenew || false,
          },
          success: function (data) {
            // Handle the response from the server
            console.log(data);
            outputData = data.data;
            $(".loadingDiv").hide();
            $(".certInfo").show();
            if (outputData.cert && outputData.key) { // è¯ä¹¦è·å–æˆåŠŸ
              updateStep(3); // è¿›å…¥ç¬¬ä¸‰æ­¥
              $(".certInfo").html(
                "ğŸ‰ è¯ä¹¦è·å–æˆåŠŸï¼è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶è¯ä¹¦å†…å®¹æˆ–ä¸‹è½½è¯ä¹¦æ–‡ä»¶ã€‚"
              );
              $(".certInfo").addClass('success-message');
              $("#getCertID").hide();
              $("#certBtns").addClass('show');
              // é‡ç½®å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ ‡å¿—
              window.forceRenew = false;
            } else {
              $(".certInfo").html(data.data.stdout + "\n" + data.data.stderr);
            }
          },
          error: function (xhr, status, error) {
            // Handle any errors
            console.error("Error:", error);
          },
        });
      });

      // å¤åˆ¶è¯ä¹¦
      $("#copyCertData").click(function (event) {
        if (outputData) {
          var certData = outputData.cert;
          navigator.clipboard.writeText(certData).then(
            function () {
              showToast("è¯ä¹¦å¤åˆ¶æˆåŠŸ");
            },
            function (err) {
              console.error("è¯ä¹¦å¤åˆ¶å¤±è´¥", err);
            }
          );
        } else {
          showToast("è¯·å…ˆè·å–è¯ä¹¦");
        }
      });

      // å¤åˆ¶ç§˜é’¥
      $("#copyCertKeyData").click(function (event) {
        if (outputData) {
          var certKeyData = outputData.key;
          navigator.clipboard.writeText(certKeyData).then(
            function () {
              showToast("ç§˜é’¥å¤åˆ¶æˆåŠŸ");
            },
            function (err) {
              console.error("ç§˜é’¥å¤åˆ¶å¤±è´¥", err);
            }
          );
        } else {
          showToast("è¯·å…ˆè·å–è¯ä¹¦");
        }
      });
      // ä¸‹è½½è¯ä¹¦
      $("#downlaodCert").click(function (event) {
        if (outputData) {
          var certData = outputData.cert;
          var certKeyData = outputData.key;
          var domain = $('input[name="domain"]').val();
          domain = domain.replace("*", "wildcard");
          const zip = new JSZip();
          zip.file(`${domain}.pem`, certData);
          zip.file(`${domain}.key`, certKeyData);
          zip.generateAsync({ type: "blob" }).then(function (content) {
            window.saveAs(content, domain + ".zip");
            showToast("ä¸‹è½½è¯ä¹¦æˆåŠŸï¼");
          });
        } else {
          showToast("è¯·å…ˆè·å–è¯ä¹¦ï¼");
        }
      });
      
      // é‡ç½®è¡¨å•
      $("#resetForm").click(function (event) {
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        updateStep(1);
        $(".inputEmailDiv").show();
        $(".showInfo").hide();
        $(".certInfo").hide().removeClass('success-message error-message');
        $(".buttonsDiv").hide();
        $("#certBtns").removeClass('show');
        $("#getCertID").show();
        $('input[name="domain"]').val('');
        $('input[name="bedStatus"][value="1"]').prop('checked', true);
        $('.radio-item').removeClass('selected');
        $('input[name="bedStatus"][value="1"]').closest('.radio-item').addClass('selected');
        selectRadio = 1;
        outputData = null;
        showToast("å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹ç”Ÿæˆè¯ä¹¦");
      });
      
      // æ£€æŸ¥è¯ä¹¦çŠ¶æ€æŒ‰é’®
      $("#checkCertStatus").click(function() {
        const domain = $('input[name="domain"]').val().trim();
        checkCertificateStatus(domain);
      });
      
      // å¼ºåˆ¶é‡æ–°ç”Ÿæˆè¯ä¹¦æŒ‰é’®
      $("#forceRenewCert").click(function() {
        const domain = $('input[name="domain"]').val().trim();
        if (!domain) {
          showToast("è¯·å…ˆè¾“å…¥åŸŸå");
          return;
        }
        
        if (confirm("ç¡®å®šè¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆè¯ä¹¦å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰çš„è¯ä¹¦æ–‡ä»¶ã€‚")) {
          // éšè—è¯ä¹¦çŠ¶æ€åŒºåŸŸï¼Œé‡ç½®ç•Œé¢
          $(".cert-status-section").hide();
          updateStep(1);
          $(".showInfo").hide();
          $(".certInfo").hide().removeClass('success-message error-message');
          $(".buttonsDiv").hide();
          $("#certBtns").removeClass('show');
          $("#getCertID").show();
          
          // è®¾ç½®å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ ‡å¿—å¹¶å¼€å§‹ç”Ÿæˆ
          window.forceRenew = true;
          $("#getTxtRecordID").click();
        }
      });
      
      // åŸŸåè¾“å…¥æ¡†å˜åŒ–æ—¶è‡ªåŠ¨æ£€æŸ¥è¯ä¹¦çŠ¶æ€
      $('input[name="domain"]').on('input', function() {
        const domain = $(this).val().trim();
        if (domain && domain.length > 3) {
          // å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
          clearTimeout(window.domainCheckTimeout);
          window.domainCheckTimeout = setTimeout(function() {
            checkCertificateStatus(domain);
          }, 1000);
        } else {
          $(".cert-status-section").hide();
        }
      });
      
      // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
      $('input[name="bedStatus"]:checked').closest('.radio-item').addClass('selected');
      // ============================
    });
  </script>
</body>

</html>